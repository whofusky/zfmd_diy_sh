===============================================================
防火墙配置脚本使用说明    孙建军    2019.1.23

===============================================================
使用说明：

第一步：按项目现场网络配置编辑network.conf配置文件

注意：
编辑时请注意格式，不要插入不必要的空格、不可见字符等。
配置项说明详见“配置文件中各配置项说明”一节。

第二步：把包中文件复制到各台服务器上（共5台）
1，以root用户登录到操作系统；
2，复制本文件包中文件到“/zfmd/wpfs20/safe”文件夹；
3，复制正确的network.conf到“/zfmd/wpfs20/safe”文件夹；
4，在“/zfmd/wpfs20/safe”文件夹中打开一个终端窗口并执行下面命令；
chmod u+x *.sh

第三步：在各台服务器上执行脚本完成防火墙设置
1，以root用户登录到操作系统；
2，在“/zfmd/wpfs20/safe”文件夹中打开一个终端窗口并执行下面命令；
1）气象服务器
./fw_ms.sh
2）主预测服务器
./fw_ps1.sh
3）备预测服务器
./fw_ps2.sh
4）SCADA服务器
./fw_scada.sh
5）工作站
./fw_ws.sh
3，检查执行结果是否正确，或拍照回传确认；

第四步：观察各服务器软件通信是否正常

其他：脚本提供了对防火墙的一些操作，执行方法同上。
1，在本机永久打开防火墙
./fw.sh start
1，在本机永久停用防火墙
./fw.sh stop
1，查看本机防火墙
./fw.sh view

===============================================================
配置文件中各配置项说明：

1，TIME_PORT_FIRST和TIME_PORT_LAST
校时服务使用的开始端口号和结束端口号。
各服务器校时服务使用的端口号（包括监听端口）必须都在此范围内。
例如以下设置表示校时使用6801到6809的端口：
TIME_PORT_FIRST=6801
TIME_PORT_LAST=6809

2，DC_PORT
数据中心软件使用的监听端口。
例如以下设置表示数据中心使用9009监听端口：
DC_PORT=9009

3，WEB_PORT
JAVA平台软件使用的监听端口。
例如以下设置表示JAVA平台软件使用8080监听端口：
WEB_PORT=8080

4，AUDIT_IP和AUDIT_PORT1、AUDIT_PORT2
日志审计、网络安全管理等审计功能使用的IP和端口。
例如以下设置表示连接100.110.120.50服务器的8800、8801监听端口来上报审计信息：
AUDIT_IP=100.110.120.50
AUDIT_PORT1=8800
AUDIT_PORT2=8801

5，METEO1_IP和METEO2_IP
气象服务器从云平台下载数据的两个IP。
例如以下设置表示从42.121.65.50和182.254.227.250下载场外数据：
METEO1_IP=42.121.65.50
METEO2_IP=182.254.227.250

6，MS_BID_NIC1和MS_BID_NIC2
气象服务器连接反隔的两块网卡的接口名称。
例如以下设置代表气象服务器操作系统eth1和eth2网卡连接反隔：
MS_BID_NIC1=eth1
MS_BID_NIC2=eth2

7，WS_IP
工作站的内网IP。
例如以下设置代表工作站的内网IP为100.110.120.40
WS_IP=100.110.120.40

8，WS_CLIENTS
工作站上提供的其他多个客户端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
远程端使用“:”分隔为IP和端口两部分。
例如以下配置代表工作站100.110.120.40可以连接访问10.11.0.80上的监听端口8080，100.110.120.40可以连接访问10.11.0.80上的监听端口8081:
WS_CLIENTS=(100.110.120.40/10.11.0.80:8080 100.110.120.40/10.11.0.80:8081)

9，PS1_IP
主预测服务器的内网IP。
例如以下设置代表主预测服务器的内网IP为100.110.120.20：
PS1_IP=100.110.120.20

10，PS1_BID_NIC
主预测服务器连接反隔的网卡的接口名称。
例如以下设置代表主预测服务器操作系统eth3网卡连接反隔：
PS1_BID_NIC=eth3

11，PS1_SERVERS
主预测服务器上提供的其他多个服务端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
本地端使用“:”分隔为IP和端口两部分。
例如以下配置代表主预测服务器有在43.113.82.2上的监听端口6960允许10.43.31.109访问，有在43.113.82.2上的监听端口6960允许43.10.23.3访问:
PS1_SERVERS=(43.113.82.2:6960/10.43.31.109 43.113.82.2:6960/43.10.23.3)

12，PS1_CLIENTS
主预测服务器上提供的其他多个客户端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
远程端使用“:”分隔为IP和端口两部分。
例如以下配置代表主预测服务器100.110.120.20可以连接访问10.11.0.10上的监听端口22，100.110.120.20可以连接访问10.11.0.20上的监听端口22:
PS1_CLIENTS=(100.110.120.20/10.11.0.10:22 100.110.120.20/10.11.0.20:22)
 
13，PS2_IP
备预测服务器的内网IP。
例如以下设置代表备预测服务器的内网IP为100.110.120.30：
PS2_IP=100.110.120.30

14，PS2_BID_NIC
备预测服务器连接反隔的网卡的接口名称。
例如以下设置代表备预测服务器操作系统eth5网卡连接反隔：
PS2_BID_NIC=eth5

15，PS2_SERVERS
备预测服务器上提供的其他多个服务端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
本地端使用“:”分隔为IP和端口两部分。
例如以下配置代表备预测服务器有在43.113.82.2上的监听端口6960允许10.43.31.109访问，有在43.113.82.2上的监听端口6960允许43.10.23.3访问:
PS2_SERVERS=(43.113.82.2:6960/10.43.31.109 43.113.82.2:6960/43.10.23.3)

16，PS2_CLIENTS
备预测服务器上提供的其他多个客户端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
远程端使用“:”分隔为IP和端口两部分。
例如以下配置代表备主预测服务器100.110.120.20可以连接访问10.11.0.10上的监听端口22，100.110.120.20可以连接访问10.11.0.20上的监听端口22:
PS2_CLIENTS=(100.110.120.20/10.11.0.10:22 100.110.120.20/10.11.0.20:22)

17，SCADA_IP
SCADA服务器的内网IP。
例如以下设置代表SCADA服务器的内网IP为100.110.120.10：
SCADA_IP=100.110.120.10

18，SCADA_SERVERS
SCADA服务器上提供的其他多个服务端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
本地端使用“:”分隔为IP和端口两部分。
例如以下配置代表SCADA服务器有在43.113.82.2上的监听端口6960允许10.43.31.109访问，有在43.113.82.2上的监听端口6960允许43.10.23.3访问:
SCADA_SERVERS=(43.113.82.2:6960/10.43.31.109 43.113.82.2:6960/43.10.23.3)

19，SCADA_CLIENTS
SCADA服务器上提供的其他多个客户端TCP连接。
括号中各个连接是使用空格分开的各个连接。
每个连接使用“/”分隔，左边是本地，右边是远程。
远程端使用“:”分隔为IP和端口两部分。
例如以下配置代表SCADA服务器100.110.120.20可以连接访问10.11.0.10上的监听端口22，100.110.120.20可以连接访问10.11.0.20上的监听端口22:
SCADA_CLIENTS=(100.110.120.20/10.11.0.10:22 100.110.120.20/10.11.0.20:22)

===============================================================
本部署包中的network.conf文件以梅桥镇的配置为例。
以下列出梅桥镇的网络配置。

===============================================================
梅桥镇网络配置：
一、所有5台计算机
1，禁止以下(不只是一)所列外的所有访问；
2，允许本机互相访问；
3，允许PING；
二、气象服务器1台
1，允许对远程123端口的UDP访问（NTP服务）；
2，允许对42.121.65.50/182.254.227.250的远程20和21和1024:65535监听端口的访问，允许对本机1024:65535监听端口的访问（气象下载）；
3，允许对反隔连接的两块网卡的访问（反隔传送）；
三、主预测服务器
1，允许本机与备预测服务器、SCADA服务器及工作站计算机在端口范围6801到6809的互相连接访问（时间同步）；
2，允许本机从UDP端口514的发送（rsyslog服务）；
3，允许本机连接100.110.120.50的监听端口8800进行访问（网安探针）；
4，允许反隔网卡的访问；
5，允许工作站对本机8080监听端口的访问；（JAVA平台）
6，允许SCADA服务器、备预测服务器、工作站对本机9009监听端口的访问；（各应用对数据中心软件的服务器间访问）
7，允许本机对备预测服务器的9009监听端口的访问；（允许访问备机数据中心软件）
8，允许对本机监听服务端的访问：
（1）上传：本地43.113.82.2的监听端口6960允许10.43.31.109和43.10.23.3来连接和通信；
（2）上传：本地43.115.13.66的监听端口6960允许10.43.31.109和43.10.23.3来连接和通信；
9，允许本机对远程监听端口的访问：
（1）集控：允许本地100.110.120.20连接10.11.0.10和10.11.0.20的监听端口22并通信；

四、备预测服务器
1，允许本机与主预测服务器、SCADA服务器及工作站计算机在端口范围6801到6809的互相连接访问（时间同步）；
2，允许本机从UDP端口514的发送（rsyslog服务）；
3，允许本机连接100.110.120.50的监听端口8800进行访问（网安探针）；
4，允许反隔网卡的访问；
5，允许工作站对本机8080监听端口的访问；（JAVA平台）
6，允许SCADA服务器、主预测服务器、工作站对本机9009监听端口的访问；（各应用对数据中心软件的服务器间访问）
7，允许本机对主预测服务器的9009监听端口的访问；（允许访问主机数据中心软件）
8，允许对本机监听服务端的访问：
（1）上传：本地43.113.82.2的监听端口6960允许10.43.31.109和43.10.23.3来连接和通信；
（2）上传：本地43.115.13.66的监听端口6960允许10.43.31.109和43.10.23.3来连接和通信；
9，允许本机对远程监听端口的访问：
（1）集控：允许本地100.110.120.20连接10.11.0.10和10.11.0.20的监听端口22并通信；

五、SCADA服务器
1，允许本机与主预测服务器、SCADA服务器及工作站计算机在端口范围6801到6809的互相连接访问（时间同步）；
2，允许本机从UDP端口514的发送（rsyslog服务）；
3，允许本机连接100.110.120.50的监听端口8800进行访问（网安探针）；
4，允许本机对预测服务器、备预测服务器的9009监听端口的访问；（允许访问数据中心软件）；
5，允许对本机监听服务端的访问：
（1）给远动测风数据：本地198.123.0.101的监听端口2404允许198.123.0.198来连接和通信；
（2）给远动理论功率：本地198.122.0.100的监听端口2404允许198.122.0.198来连接和通信；
6，允许本机对远程监听端口的访问：
（1）采集测风塔数据：允许本地192.168.144.5连接192.168.144.4的监听端口502并通信；
（2）采集风机数据：允许本地10.128.99.160连接10.128.99.11的监听端口5020并通信；
（3）采集整场数据：允许本地198.124.0.100连接198.124.0.202的监听端口2404并通信；

六、工作站
1，允许本机与主预测服务器、备预测服务器、SCADA服务器在端口范围6801到6809的互相连接访问；（时间同步）
2，允许本机从UDP端口514的发送（rsyslog服务）；
3，允许本机连接100.110.120.50的监听端口8800进行访问（网安探针）；
4，允许本机对主预测服务器、备预测服务器8080监听端口的访问；（允许访问JAVA平台）
5，允许本机对主预测服务器、备预测服务器的9009监听端口的访问；（允许访问数据中心软件）

===============================================================
