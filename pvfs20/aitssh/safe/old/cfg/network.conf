#!/bin/bash
#
#
########################################################################
#author       :    fushikai
#date         :    20190519
#linux_version:    Red Hat Enterprise Linux Server release 6.7
#dsc          :
#       Wind power prediction system 2.0linux system software firewall 
#       configuration file template
#
#    
#revision history:
#       v0.0.0.1  @ 20190723
#       2019-09-23 modify v0.0.0.1 version to V20.01.000
#       2021-11-19 modify V20.01.000 version to V20.01.010
#       
#
########################################################################



#此值判断文件是否已经加载，修改配置文件时此t处不用修改
[ ! -z "${Already_loadedCfg_Flag}" ] && return 0
Already_loadedCfg_Flag=1








###############################################################
#
#       第 零 部分 : 【总体说明】  
#
# 1. 配置文件中街道有#号的为注释行，即此行内容程序处理时忽略
# 2. 配置项的=号左右不能有空格"号须为英文半角引号
# 3. 本配置文件分为"零-四"5大总分内容
# 4. 对第一和第四大总分说明如下：
#
# 对于某一个特定的电场某一台具体的服务器来说，只对应此配置文件
# 中某一部分的配置在生效，什么意思呢？举例说明如下:
#
#    假如当前要处理的服务主机名为 thisIsTest,我想把当前服务器的
#    防火墙配置放在“气象服务的部分”(当然你也可以放在其他部分,没
#    有硬性的规定:如果服务名与此配置文件预设的配置名(气象、预测...)
#    相同,还是建议放在对应的服务名下;如果服务器名与预设的不同可
#    以任选一个进行修改配置即可,但需要在相应部分添加注释说明以
#    便以后维护)那么我只需要把
#       (1) "第一部分"中气象服务器主机名的变量MS_HOSTNAME值修改
#           为thisIsTest
#       (2) "第四.一部分"(如果在第(1)步中修改的是scada服务器主机
#           名则需要定位到"第四.二部分",以此类推)进行具体防火墙
#           规则的配置;
#
# 既然某一个服务器只用到了此文件的某一部分，为什么不把某个服务
# 器用不到的部分删除呢？ 
#     答案是为了便于版本控制: 一个电场只有一个防火墙配置文件
#
###############################################################








###############################################################
#
#       第 一 部分:【主机名配置区域】  
#
# 需要将当前服务器的主机名填写到对应预设的配置项的值里面,如果
# 当前服务器的名称在预设的5个配置项里没有,可将其中任何一个配置
# 项的值改为当前主机名即可(此种情况建议在配置项置的注释里加个
# 注释说明)
#
# 提示:获得当前服务名可用如下方法
#      服务器上打开终端执行: echo $HOSTNAME 得到
#
###############################################################


MS_HOSTNAME="MeteoServer"      #气象服务器 对应防火墙规则配置在第四.一部分
SCA_HOSTNAME="ScadaServer"     #scada预测服务器 对应防火墙规则配置在第四.二部分
PS1_HOSTNAME="PredictServer1"  #主预测服务器 对应防火墙规则配置在第四.三部分
PS2_HOSTNAME="PredictServer2"  #备预测服务器 对应防火墙规则配置在第四.四部分
WK_HOSTNAME="WorkStation"      #工作站 对应防火墙规则配置在第四.五部分








###############################################################
#
#       第 二 部分:【各参数控制开关区域】  
#           
#   需要修改的参数是 debugFlag, 其他参数如不明白具体指代的什么建
#   议不要修改
#
#   注: debugFlag=0时才能让配置生效
#  
###############################################################

#debugFlag=1 只输出将要配置的信息不实际写入系统；其他值则执行系统配置
debugFlag=0

#enablePing=1 开启ping功能,0关闭ping功能
enablePing=1

#enInterSsh=1 开启内网的ssh端口
enInterSsh=1

#bindNICByIP=1 根据配置的ip自动找对应的网卡号并进行绑定;0则不绑定
bindNICByIP=1








###############################################################
#
#       第 三 部分:【规则功能定义区】  
#           
#【注】此区域一定不要修改
#  
###############################################################

#outPrtFlag:产生规则的标识       0:OUTPUT,INPUT; 1:OUTPUT; 2:INPUT                 
prtAll=0
prtIn=2
prtOut=1

#server_opFlag:在连接状中是作为client还是server   0:client; 1:server; 2:client,server; 3:stat null
srvOp_client=0
srvOp_server=1
srvOp_all=2
srvOp_null=3
srvop_null=3

#op_protocol:所用协议标识        tcp,upd,all
op_tcp="tcp"
op_udp="udp"
op_all="all"








###############################################################
#
#       第 四 部分:【服务器防火墙具体规则配置区域】  
#
# 注意此部分所有符号都需要是在英文半角状态下输入,如: " | - 等等
#
# 1.此部分配置项名可变与不可变说明:
#  (1)不可变配置项名称的有:
#     cfg_rule_items_**  配置具体的规则 (其中**在不同的部分名称不一样,如气象对应qx,预测主对应ps1等等)
#     cfg_rule_ssh_**    配置不同服务器之间ssh连接 (其中**在不同的部分名称不一样,如预测主对应ps1 等等)
#     iptb_dir_rule_**   配置直接iptables命令字符串 (其中**在不同的部分名称不一样,如预测主对应ps1 等等)
#  (2)可变配置项名称的有:
#     除了(1)之外的都可以变名;
#     可变名的配置项本质上只是为了作为公共变量的作用，为了在后面的配置规则中用${名}来引用此项的值而已,
#     因此可变配置项甚至可以删除不要（只需要在后面规则配置中用实际的ip或端口就可以)
#  (3)其他注意的有
#     模板中可变配置项是可以删除或变名的，这需要根据现场的情况来定，也可以根据配置人的习惯来定，如果不喜欢用变量的形式可以把所有可变配置项删除
#     不可变名配置项，当现场不需要此项时，不可删除此项，但可以将值设置为""(空)即可
#
# 2.cfg_rule_items_** 与 cfg_rule_ssh_** 配置项的值配置说明:
#  (1) 配置项的值需要用""引用起来,值为空时则直接等于""即可
#  (2) 值的组成由多条规则组成,每一条规则占一行,多个规则用|分隔
#  (3) 每一条规则的格式为: Domain1/Domain2/Domain3/Domain4/Domain5/Domain6
#     (3.1) 其中Domain*是可变的对应不同的规则实际的值不一样，符号/是固定的不能少
#          Domain1可用的值为:${prtAll}、${prtIn}、${prtOut},不确定用什么值时建议用${prtAll}
#          Domain2可用的值为:${srvOp_client}、${srvOp_server}、${srvOp_null},不确定用什么值时建议用${srvOp_null}
#          Domain3可用的值为:${op_tcp}、${op_udp}、${op_all},不确定用什么值时建议用${op_all}
#          Domain4此处需要填入网号,在Domain5有值时此处可不填写(为空即可)
#          Domain5此处填写当前服务器本地的网络地址
#          Domain6此处填写与Domain5通信的对端网络地址
#     (3.2) Domain5或Domain6处的网络地址的一般形式为 ip:端口号
#          允许只有Ip或只有端口号的情况，但只有端口号时端口号前的:号不能省略
#          端口号可以是连续和多个端口号用-线连接如 1024-65535
#          端口号可以是多个不连接的用,号分隔如 20,21,1024-65535
#     (3.3) Domain5与Domain6在一般情况下是不能为空了,除特殊情况如在配置
#           正隔或反隔的网卡规则时可为,此时Domain4不能为空,此时典型的规则
#           形式如下:
#            客户端(一般为气象服务器):
#               ${prtAll}/${srvOp_client}/${op_all}/反隔网卡号//
#            服务端(一般为预测服务器):
#               ${prtAll}/${srvOp_server}/${op_all}/反隔网卡号//
#   (4) cfg_rule_ssh_** 此配置项是为了配置在同网段内的各服务器之间可以ssh连接的,
#       此配置项的值不是必须的，可以为空。
#
# 3.iptb_dir_rule_** 配置项的值配置说明:
#    (1) 此配置项一般情况为空，只有在cfg_rule_items_**和cfg_rule_ssh_**配置项
#        里都不能满足要求时才配置此项
#    (2) 配置的值用""括起来，多条规则分多行填写，每一条规则占一行;
#    (3) 每一条规则就是一个完整的iptable 命令
#
#
###############################################################

 






###############################################################
#
#       第 四.零 部分:【共用ip或端口区域】  
#                                                
#                                                
#                                                
###############################################################
#
ssh_port=22            #ssh连接端口
database_port=1521     #数据库访问端口
DC_PORT=9009           #数据中心软件使用的监听端口
TIME_PORT=6801-6809    #校时服务使用的端口号,如果是固定的也可写成固定端口
WEB_PORT=8080          #JAVA平台软件使用的监听端口
AUDIT_IP=100.110.120.50    #日志审计、网络安全管理等审计功能使用的IP
AUDIT_PORT=1024-65535      #日志审计、网络安全管理等审计功能使用的端口,如果是固定的也可写成固定端口








###############################################################
#
#       第 四.一 部分:【气象服务器 规则配置区域】  
#                                                
#                                              
# cfg_rule_items_qx 和 iptb_dir_rule_qx这两个配置项的名不可改变
#
# 除上面2个配置项外的其他项(变量)可以修改删除或添加，原则是在后
# 面规则里是否用到这些配置项或者不用变量形势直接用ip或端口时可
# 以直接删除这些变量
#                                             
###############################################################
#

qx_local_fg_ip1="10.1.1.10"             #气象本地反隔ip1
qx_local_fg_ip2="10.1.2.10"            #气象本地反隔ip2
qx_local_extranet_ip="192.168.1.181"    #气象本地联外网的Ip
qx_ftp_server_ip1="42.121.65.50"        #气象ftp远程ip1
qx_ftp_server_ip2="182.254.227.250"     #气象ftp远程ip2
qx_fg_NIC_name1="p2p1"                   #气象反隔网卡号1
qx_fg_NIC_name2="p2p2"                   #气象反隔网卡号2

cfg_rule_items_qx="
    ${prtAll}/${srvOp_null}/${op_udp}//${qx_local_extranet_ip}/:123
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1}:21
 |  ${prtAll}/${srvOp_server}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1}:20
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip1}:1024-65535
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip2}:21
 |  ${prtAll}/${srvOp_server}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip2}:20
 |  ${prtAll}/${srvOp_client}/${op_tcp}//${qx_local_extranet_ip}/${qx_ftp_server_ip2}:1024-65535
 |  ${prtAll}/${srvOp_client}/${op_all}/${qx_fg_NIC_name1}//
 |  ${prtAll}/${srvOp_client}/${op_all}/${qx_fg_NIC_name2}//
"

iptb_dir_rule_qx=""








###############################################################
#
#       第 四.二 部分:【SCADA服务器 规则配置区域】  
#                                                
# cfg_rule_items_scada,iptb_dir_rule_scada,cfg_rule_ssh_scada 
# 这3个配置项的名不可改变
#
# 除上面3个配置项外的其他项(变量)可以修改删除或添加，原则是在后
# 面规则里是否用到这些配置项或者不用变量形势直接用ip或端口时可
# 以直接删除这些变量
#                                             
#                                                
#                                                
###############################################################
#

scada_local_intranet_ip="100.110.120.10"  #scada内部网络ip
ps1_local_intranet_ip="100.110.120.20"    #主预测内部网络ip
ps2_local_intranet_ip="100.110.120.30"    #备预测内部网络ip
wk_local_intranet_ip="100.110.120.40"     #工作站内部网络ip



cfg_rule_items_scada="
   ${prtAll}/${srvOp_client}/${op_tcp}//${scada_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${DC_PORT}
  |${prtAll}/${srvOp_null}/${op_all}//${scada_local_intranet_ip}:${AUDIT_PORT}/${AUDIT_IP}
  |${prtAll}/${srvOp_server}/${op_tcp}//198.123.0.1:2404/198.123.0.200
  | ${prtAll}/${srvOp_server}/${op_tcp}//198.122.0.1:502/198.122.0.200
  | ${prtAll}/${srvOp_client}/${op_tcp}//193.122.0.101:1024-65535/193.122.0.10
  | ${prtAll}/${srvOp_client}/${op_tcp}//198.124.0.1:1024-65535/198.124.0.200
  | ${prtAll}/${srvOp_client}/${op_tcp}//100.110.120.10:5406-5407/100.110.120.20
  | ${prtAll}/${srvOp_null}/${op_tcp}//${scada_local_intranet_ip}:${TIME_PORT}/${ps1_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${TIME_PORT}
"

cfg_rule_ssh_scada="
     ${prtAll}/${srvOp_client}/${op_tcp}//${scada_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${ssh_port}
    |${prtAll}/${srvOp_server}/${op_tcp}//${scada_local_intranet_ip}:${ssh_port}/${ps1_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}
"

iptb_dir_rule_scada=""








###############################################################
#
#       第 四.三 部分:【预测主服务器 规则配置区域】  
#                                                
# cfg_rule_items_ps1,iptb_dir_rule_ps1,cfg_rule_ssh_ps1 
# 这3个配置项的名不可改变
#
# 除上面3个配置项外的其他项(变量)可以修改删除或添加，原则是在后
# 面规则里是否用到这些配置项或者不用变量形势直接用ip或端口时可
# 以直接删除这些变量
#                                                
#                                                
###############################################################
#

ps1_fg_NIC_name1="em2"                   #预测主反隔网卡号

upload_remote_ips="10.36.131.1,10.36.131.2,36.10.27.1,36.10.27.2" #上传省调的ip
ps1_upload_localip="36.100.192.169"      #预测主上传时本地Ip

upload_Jk_ips="192.168.0.2"              #sftp上传文件到集控ip
sftp_port=22                             #sftp上传文件端口
ps1_upload_lsftpIp="192.168.0.3"         #sftp上传文件本地ip


cfg_rule_items_ps1="
    ${prtAll}/${srvOp_server}/${op_all}/${ps1_fg_NIC_name1}//
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${WEB_PORT}/${wk_local_intranet_ip}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${DC_PORT}/${wk_local_intranet_ip},${ps2_local_intranet_ip},${scada_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps1_local_intranet_ip}/${ps2_local_intranet_ip}:${DC_PORT}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${database_port}/${ps2_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps1_local_intranet_ip}/${ps2_local_intranet_ip}:${database_port}
  | ${prtAll}/${srvOp_null}/${op_udp}//192.168.1.199:123/192.168.1.200:123
  | ${prtAll}/${srvOp_server}/${op_tcp}//100.110.120.130:502-503/100.110.120.137
  | ${prtAll}/${srvOp_client}/${op_tcp}//100.110.120.130/100.110.120.136:2404
  | ${prtAll}/${srvOp_client}/${op_tcp}//194.100.100.10/194.100.100.1:502
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps1_upload_localip}:3000/${upload_remote_ips}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps1_upload_lsftpIp}/${upload_Jk_ips}:${sftp_port}
  | ${prtAll}/${srvOp_null}/${op_tcp}//${ps1_local_intranet_ip}:${TIME_PORT}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${TIME_PORT}
"

cfg_rule_ssh_ps1="
     ${prtAll}/${srvOp_client}/${op_tcp}//${ps1_local_intranet_ip}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}:${ssh_port}
    |${prtAll}/${srvOp_server}/${op_tcp}//${ps1_local_intranet_ip}:${ssh_port}/${scada_local_intranet_ip},${ps2_local_intranet_ip},${wk_local_intranet_ip}
"

iptb_dir_rule_ps1=""








###############################################################
#
#       第 四.四 部分:【预测备服务器 规则配置区域】  
#                                                
# cfg_rule_items_ps2,iptb_dir_rule_ps2,cfg_rule_ssh_ps2 
# 这3个配置项的名不可改变
#
# 除上面3个配置项外的其他项(变量)可以修改删除或添加，原则是在后
# 面规则里是否用到这些配置项或者不用变量形势直接用ip或端口时可
# 以直接删除这些变量
#                                                
#                                                
###############################################################
#
#

ps2_fg_NIC_name1="eth0"                   #预测主反隔网卡号
ps2_upload_localip="36.100.192.169"      #预测备上传时本地Ip
ps2_upload_lsftpIp="192.168.0.4"         #sftp上传文件本地ip

cfg_rule_items_ps2="
    ${prtAll}/${srvOp_server}/${op_all}/${ps2_fg_NIC_name1}//
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${WEB_PORT}/${wk_local_intranet_ip}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${DC_PORT}/${wk_local_intranet_ip},${ps1_local_intranet_ip},${scada_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_local_intranet_ip}/${ps1_local_intranet_ip}:${DC_PORT}
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${database_port}/${ps1_local_intranet_ip}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_local_intranet_ip}/${ps1_local_intranet_ip}:${database_port}
  | ${prtAll}/${srvOp_null}/${op_udp}//192.168.1.199:123/192.168.1.200:123
  | ${prtAll}/${srvOp_server}/${op_tcp}//100.110.120.130:502-503/100.110.120.137
  | ${prtAll}/${srvOp_client}/${op_tcp}//100.110.120.130/100.110.120.136:2404
  | ${prtAll}/${srvOp_client}/${op_tcp}//194.100.100.10/194.100.100.1:502
  | ${prtAll}/${srvOp_server}/${op_tcp}//${ps2_upload_localip}:3000/${upload_remote_ips}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_upload_lsftpIp}/${upload_Jk_ips}:${sftp_port}
  | ${prtAll}/${srvOp_null}/${op_tcp}//${ps2_local_intranet_ip}:${TIME_PORT}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_local_intranet_ip}:${TIME_PORT}
"

cfg_rule_ssh_ps2="
     ${prtAll}/${srvOp_client}/${op_tcp}//${ps2_local_intranet_ip}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_local_intranet_ip}:${ssh_port}
    |${prtAll}/${srvOp_server}/${op_tcp}//${ps2_local_intranet_ip}:${ssh_port}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_local_intranet_ip}
"

iptb_dir_rule_ps2=""








###############################################################
#
#       第 四.五 部分:【工作站服务器 规则配置区域】  
#                                                
# cfg_rule_items_wk,iptb_dir_rule_wk,cfg_rule_ssh_wk 
# 这3个配置项的名不可改变
#
# 除上面3个配置项外的其他项(变量)可以修改删除或添加，原则是在后
# 面规则里是否用到这些配置项或者不用变量形势直接用ip或端口时可
# 以直接删除这些变量
#                                                
#                                                
###############################################################
#
#

cfg_rule_items_wk="
    ${prtAll}/${srvOp_client}/${op_tcp}//${wk_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${WEB_PORT}
  | ${prtAll}/${srvOp_client}/${op_tcp}//${wk_local_intranet_ip}/${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${DC_PORT}
  | ${prtAll}/${srvOp_null}/${op_tcp}//${wk_local_intranet_ip}:${TIME_PORT}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${TIME_PORT}
"

cfg_rule_ssh_wk="
     ${prtAll}/${srvOp_client}/${op_tcp}//${wk_local_intranet_ip}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${ps2_local_intranet_ip}:${ssh_port}
    |${prtAll}/${srvOp_server}/${op_tcp}//${wk_local_intranet_ip}:${ssh_port}/${scada_local_intranet_ip},${ps1_local_intranet_ip},${wk_localps2_local_intranet_ip}
"

iptb_dir_rule_wk=""








###############################################################
###############################################################

